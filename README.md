# 労働安全衛生チャットボット

AI搭載のウェブベース顧客サポートチャットボット。労働安全衛生に関する質問に回答し、ナレッジベースを管理できるシステムです。

## 主な機能

- **AI チャット機能**: 3つのAIプロバイダーに対応（Google Gemini、OpenAI ChatGPT、Anthropic Claude）
- **ナレッジベース統合**: 労働安全衛生に関する知識を検索・参照
- **ナレッジ管理**: ウェブインターフェースから新しい知識を追加可能
- **カテゴリー分類**: 法律・規則、労働災害、健康管理、保護具など6つのカテゴリー
- **会話履歴**: コンテキストを保持した連続した対話
- **柔軟なAI選択**: 環境変数で簡単にAIプロバイダーを切り替え可能

## システムプロンプト

本システムでは、以下のシステムプロンプトを使用しています：

```
あなたは労働安全衛生の専門家である労働安全コンサルタントとして機能する、
AI搭載のウェブベース・チャットボットです。労働安全衛生に関するあらゆる質問に対して、
専門的な知識と経験に基づいて回答します。

あなたの役割:
- 労働安全コンサルタントとして、労働安全衛生全般に関する質問に専門的に回答する
- 内部ナレッジベースは重要な情報源として積極的に活用する
- 法令、事例、実務的な対策、予防措置など、幅広いトピックに対応する
- 一般論、業界のベストプラクティス、法令の基本原則などを活用して回答する

【最重要】ナレッジベースの取り扱いルール:

1. ナレッジベースの活用方法:
   - 【参考ナレッジベース】が提供された場合、必ずその内容を参考にして回答すること
   - ナレッジベースに記載されている情報（対策、手順、注意点など）は積極的に回答に含める
   - ナレッジベースの内容を元に、専門家として分かりやすく説明する

2. デフォルトの回答方法（通常の質問）:
   「〜について教えて」「〜の対策は」などの一般的な質問の場合:

   許可・推奨: ナレッジベースに記載されている対策、手順、内容を使って回答する
   禁止: 災害事例の詳細描写（「〇〇工事で」「〇〇作業中に、〜という災害が発生」など）、
         URL、「詳細:」「ナレッジベース参照」などの表示

   重要: ナレッジベースに「対策」「方法」「手順」などが記載されている場合は、
         それを積極的に活用して回答してください

3. 事例提示が許される条件:
   ユーザーが「事例を示して」「具体例を教えて」「実例を見せて」「災害事例を教えて」などと
   明示的に事例を要求した場合のみ、ナレッジベースの具体的な災害事例の内容を提示できる

4. 質問の種類の判別:
   - 「対策を教えて」→ ナレッジベースの対策内容を使って回答（災害事例の詳細は提示しない）
   - 「方法を教えて」→ ナレッジベースの方法を使って回答（災害事例の詳細は提示しない）
   - 「事例を教えて」→ ナレッジベースの具体的な災害事例を提示（OK）

5. ナレッジベースがない場合:
   ナレッジベースに情報がない場合でも、必ず専門家としての一般論で回答すること

6. 絶対禁止:
   - 「ナレッジベースに情報がない」などとナレッジベースの有無に言及すること
   - 回答を拒否すること

回答のスタイル:
- 自然で会話的な日本語で回答する
- 基本的には簡潔に（2〜5文程度）まとめる
- ユーザーが「詳しく」「詳細に」と求めた場合は、包括的な説明を提供する
- 重要な安全事項については、予防的な安全ヒントも積極的に提示する

重要:
【参考ナレッジベース】が提供された場合は、その内容を必ず参考にして回答してください。
ただし、災害事例の具体的な詳細描写やURLは、ユーザーが明示的に事例を求めた場合のみ提示してください。
```

## プロジェクト構造

```
chatbot/
├── public/              # フロントエンド（ブラウザで表示）
│   ├── index.html      # メインHTML
│   ├── style.css       # スタイルシート
│   └── script.js       # クライアント側JavaScript
├── src/                # バックエンド
│   └── server.js       # Express サーバー + API
├── data/               # データ保存
│   └── knowledge.json  # ナレッジベース（JSON形式）
├── package.json        # Node.js 依存関係
├── .env.example        # 環境変数の例
├── .gitignore          # Git除外設定
└── README.md           # このファイル
```

## セットアップ

### 1. 依存関係のインストール

```bash
npm install
```

### 2. 環境変数の設定

`.env.example` をコピーして `.env` ファイルを作成します。

```bash
cp .env.example .env
```

`.env` ファイルを編集して、使用したいAIプロバイダーを選択し、対応するAPIキーを設定します：

#### オプション1: Google AI Studio (Gemini) - おすすめ

```env
AI_PROVIDER=google
GOOGLE_API_KEY=your_google_api_key_here
PORT=3000
```

**Google API キーの取得方法:**
1. https://aistudio.google.com/app/apikey にアクセス
2. Googleアカウントでログイン
3. 「Create API Key」をクリック
4. 無料枠が大きく、高性能なGemini 1.5 Flashが使えます

#### オプション2: OpenAI (ChatGPT)

```env
AI_PROVIDER=openai
OPENAI_API_KEY=your_openai_api_key_here
PORT=3000
```

**OpenAI API キーの取得方法:**
1. https://platform.openai.com/api-keys にアクセス
2. アカウントを作成またはログイン
3. 「Create new secret key」をクリック
4. GPT-4o-miniを使用（コスト効率が良い）

#### オプション3: Anthropic (Claude)

```env
AI_PROVIDER=anthropic
ANTHROPIC_API_KEY=your_anthropic_api_key_here
PORT=3000
```

**Anthropic API キーの取得方法:**
1. https://console.anthropic.com/ にアクセス
2. アカウントを作成またはログイン
3. API Keysセクションから新しいキーを生成
4. Claude 3.5 Sonnetを使用（高品質な応答）

### 3. サーバーの起動

```bash
npm start
```

開発モード（ファイル変更時に自動再起動）：

```bash
npm run dev
```

### 4. ブラウザでアクセス

サーバー起動後、以下のURLにアクセスします：

```
http://localhost:3000
```

## 使い方

### チャット機能

1. メインページの入力欄に質問を入力
2. 送信ボタンをクリック、または Enter キーを押す
3. AIが関連するナレッジベースを参照して回答

**質問例:**
- 労働安全衛生法とは何ですか？
- 事務所で起こりやすい労働災害の例を教えてください
- 熱中症への対策を教えてください
- ストレスチェック制度とは？

### ナレッジの追加

右側パネルの「新しいナレッジを追加」フォームから：

1. カテゴリーを選択
2. 質問を入力
3. 回答を入力
4. キーワードをカンマ区切りで入力
5. 「追加」ボタンをクリック

追加されたナレッジは `data/knowledge.json` に保存され、即座にチャットで利用可能になります。

## ナレッジベースのカテゴリー

1. **法律・規則**: 労働安全衛生法、選任義務など
2. **労働災害**: 事務所・建設現場での災害、対応方法
3. **健康管理**: 定期健康診断、ストレスチェック、熱中症対策
4. **保護具・安全装置**: ヘルメット、安全帯、各種保護具
5. **リスクアセスメント**: 危険性評価、リスク低減措置
6. **安全衛生教育**: 雇入れ時教育、特別教育

## API エンドポイント

### POST `/api/chat`

チャットメッセージを送信し、AI応答を取得

**リクエスト:**
```json
{
  "message": "労働安全衛生法とは何ですか？",
  "conversationHistory": []
}
```

**レスポンス:**
```json
{
  "reply": "労働安全衛生法は...",
  "knowledgeUsed": true,
  "knowledgeCount": 3
}
```

### GET `/api/knowledge`

全ナレッジベースを取得

### POST `/api/knowledge`

新しいナレッジを追加

**リクエスト:**
```json
{
  "categoryId": "laws",
  "question": "安全管理者の選任義務とは？",
  "answer": "常時50人以上の労働者を使用する事業場では...",
  "keywords": ["安全管理者", "選任", "義務"]
}
```

### GET `/api/health`

サーバーとAPI設定の状態確認

## 技術スタック

- **フロントエンド**: HTML5, CSS3, Vanilla JavaScript
- **バックエンド**: Node.js, Express.js
- **AI API**:
  - Google AI Studio (Gemini 1.5 Flash) - デフォルト
  - OpenAI (GPT-4o-mini)
  - Anthropic (Claude 3.5 Sonnet)
- **データ保存**: JSON ファイル（将来的にはデータベース対応可能）

## カスタマイズ

### システムプロンプトの変更

`src/server.js` の `SYSTEM_PROMPT` 定数を編集してください。

### ナレッジベースの編集

`data/knowledge.json` を直接編集するか、ウェブインターフェースから追加できます。

### スタイルの変更

`public/style.css` の CSS 変数（`:root`セクション）を編集することで、
カラースキームを簡単に変更できます。

```css
:root {
    --primary-color: #2563eb;  /* メインカラー */
    --secondary-color: #10b981; /* アクセントカラー */
    /* ... */
}
```

## トラブルシューティング

### APIキーが設定されていないエラー

`.env` ファイルが存在し、正しい API キーが設定されているか確認してください。

### ポートが使用中エラー

`.env` ファイルで別のポート番号を指定してください：

```env
PORT=3001
```

### ナレッジベースが読み込まれない

`data/knowledge.json` のJSON形式が正しいか確認してください。

## インターネット上で公開する方法（デプロイ）

ローカル環境で動作確認ができたら、インターネット上で公開できます。

### おすすめの方法

#### オプション1: Render（最も簡単・おすすめ）

**特徴:**
- 完全無料プランあり
- GitHubと自動連携
- 設定が簡単

**手順:**

1. **Renderアカウント作成**
   - https://render.com/ にアクセス
   - GitHubアカウントでサインアップ

2. **新しいWebサービスを作成**
   - ダッシュボードで「New +」→「Web Service」を選択
   - GitHubリポジトリを接続（`dzr01145/chatbot`）
   - ブランチ: `claude/create-safety-chatbot-011CUU68CD2PzPJBqRSg63h9`を選択

3. **設定**
   - Name: `safety-chatbot`（任意の名前）
   - Environment: `Node`
   - Build Command: `npm install`
   - Start Command: `npm start`
   - Plan: `Free`を選択

4. **環境変数を設定**
   - 「Environment」タブで以下を追加：
   ```
   AI_PROVIDER = google
   GOOGLE_API_KEY = あなたのAPIキー
   NODE_ENV = production
   ```

5. **デプロイ**
   - 「Create Web Service」をクリック
   - 数分待つとデプロイ完了
   - URLが発行されます（例: `https://safety-chatbot-xxxx.onrender.com`）

#### オプション2: Railway

**特徴:**
- 無料枠あり（月500時間）
- シンプルな設定

**手順:**

1. **Railwayアカウント作成**
   - https://railway.app/ にアクセス
   - GitHubアカウントでサインアップ

2. **新しいプロジェクトを作成**
   - 「New Project」→「Deploy from GitHub repo」
   - リポジトリを選択

3. **環境変数を設定**
   - プロジェクト設定で「Variables」タブを開く
   - 以下を追加：
   ```
   AI_PROVIDER = google
   GOOGLE_API_KEY = あなたのAPIキー
   ```

4. **デプロイ**
   - 自動的にデプロイが開始
   - URLが発行されます

### 公開後の確認

デプロイが完了したら：
1. 発行されたURLにアクセス
2. チャット機能が正常に動作するか確認
3. ナレッジベースが読み込まれているか確認

### 注意事項

- **APIキーの管理**: 環境変数に必ず設定してください（.envファイルはGitHubにプッシュしないこと）
- **無料プランの制限**:
  - Render: 15分間アクセスがないとスリープ、起動に数秒かかる
  - Railway: 月500時間まで無料
- **カスタムドメイン**: 有料プランでカスタムドメインを設定可能

## 今後の拡張案

- [ ] ベクトルデータベース（Pinecone, Weaviate等）との統合
- [ ] ユーザー認証・権限管理
- [ ] チャット履歴の永続化
- [ ] 多言語対応
- [ ] PDFやWebページからの自動ナレッジ抽出
- [ ] 音声入力・音声読み上げ機能
- [ ] スマートフォンアプリ版

## ライセンス

MIT License

## サポート

問題が発生した場合は、GitHubのIssuesでお知らせください。
